services:
    app:
        build:
            context: .
            dockerfile: docker/php/Dockerfile
        expose:
            - "9000"
        container_name: laravel-app
        volumes:
            - ./:/var/www/html
            - ./storage:/var/www/html/storage
            - ./logs:/var/www/html/storage/logs
        networks:
            - laravel
        depends_on:
            - mysql
            - redis
        #      - meilisearch
        restart: unless-stopped

    nginx:
        image: nginx:stable
        container_name: laravel-nginx
        ports:
            - "${FORWARD_WEB_PORT:-80}:80"
            - "443:443"
        volumes:
            - ./:/var/www/html
            - ./storage:/var/www/html/storage
            - ./logs:/var/www/html/storage/logs
        depends_on:
            - app
            - reverb
        networks:
            - laravel
        restart: unless-stopped

    mysql:
        image: mysql:8.0
        container_name: laravel-mysql
        environment:
            MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
            MYSQL_ROOT_HOST: "%"
            MYSQL_DATABASE: "${DB_DATABASE}"
            MYSQL_PASSWORD: "${DB_PASSWORD}"
        ports:
            - "${FORWARD_DB_PORT:-3306}:3306"
        volumes:
            - dbdata:/var/lib/mysql
        networks:
            - laravel
        restart: unless-stopped

    redis:
        image: redis:alpine
        container_name: laravel-redis
        volumes:
            - redis_data:/data
        networks:
            - laravel
        restart: unless-stopped
        #  meilisearch:
        #    image: getmeili/meilisearch:v1.11
        #    container_name: laravel-meilisearch
        #    environment:
        #      MEILI_NO_ANALYTICS: "true"
        #    volumes:
        #      - meilidata:/meili_data
        #    networks:
        #      - laravel

    node:
        build:
            context: ./whatsapp-service
            dockerfile: Dockerfile
        container_name: laravel-node
        working_dir: /var/www/html/whatsapp-service
        command: nodemon src/index.js
        volumes:
            - ./whatsapp-service:/var/www/html/whatsapp-service
            - ./storage:/var/www/html/storage
        environment:
            - MONGO_URL=mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:${MONGO_PORT}/${MONGO_DB_NAME}?authSource=admin
            - NODE_ENV=production
        ports:
            - "4000:4000"
        depends_on:
            - mongo
        networks:
            - laravel
        restart: unless-stopped


    mongo:
        image: mongo
        container_name: laravel-mongo
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
        volumes:
            - mongo_data:/data/db
        ports:
            - "${MONGO_PORT}:27017"
        networks:
            - laravel

    mongo-express:
        image: mongo-express
        container_name: mongo-express
        restart: always
        ports:
            - "${MONGO_EXPRESS_PORT}:8081"
        environment:
            ME_CONFIG_MONGODB_URL: mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@mongo:${MONGO_PORT}/
            ME_CONFIG_BASICAUTH_ENABLED: true
            ME_CONFIG_BASICAUTH_USERNAME: ${ME_CONFIG_BASICAUTH_USERNAME}
            ME_CONFIG_BASICAUTH_PASSWORD: ${ME_CONFIG_BASICAUTH_PASSWORD}

    reverb:
        build: # Same as app (includes composer deps)
            context: .
            dockerfile: docker/php/Dockerfile
        command: php artisan reverb:start # tls=false for internal; Nginx handles SSL
        container_name: laravel-reverb
        ports:
            - "8080:8080"
        environment:
            - REVERB_APP_ID  # Pulled from .env (Docker mounts it)
            - REVERB_APP_KEY
            - REVERB_APP_SECRET
            - REVERB_HOST
            - REVERB_PORT
            - REVERB_SCHEME
        volumes:
            - .:/var/www/html  # Mounts .env and app code
        depends_on:
            - app  # If using DB/Redis
        restart: unless-stopped
        networks:
            - laravel

    horizon:
        build:
            context: .
            dockerfile: docker/php/Dockerfile
        container_name: laravel-horizon
        volumes:
            - ./:/var/www/html
            - ./docker/horizon/supervisord.conf:/etc/supervisord.conf
            - ./docker/horizon/horizon.conf:/etc/supervisor/conf.d/horizon.conf
        command: /usr/bin/supervisord -c /etc/supervisord.conf
        depends_on:
            - redis
            - mysql
        networks:
            - laravel
        restart: unless-stopped

volumes:
    dbdata:
    meilidata:
    redis_data:
    whatsapp_session:
    mongo_data:

networks:
    laravel:
        driver: bridge
